name: Release MCDR Plugin

on:
  push:
    tags:
      - 'v*'  # è§¦å‘æ¡ä»¶ï¼šæ¨é€ä»¥ 'v' å¼€å¤´çš„æ ‡ç­¾ï¼Œå¦‚ v1.0.0
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.8'
        
    - name: Get version from tag
      id: get_version
      run: |
        if [[ $GITHUB_REF == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/v}
        else
          VERSION="dev-$(date +%Y%m%d-%H%M%S)"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Version: $VERSION"
        
    - name: Update plugin version
      run: |
        # æ›´æ–° mcdreforged.plugin.json ä¸­çš„ç‰ˆæœ¬å·
        python -c "
        import json
        with open('mcdreforged.plugin.json', 'r', encoding='utf-8') as f:
            data = json.load(f)
        data['version'] = '${{ steps.get_version.outputs.version }}'
        with open('mcdreforged.plugin.json', 'w', encoding='utf-8') as f:
            json.dump(data, f, ensure_ascii=False, indent=4)
        "
        
    - name: Create plugin archive
      run: |
        # åˆ›å»ºä¸´æ—¶ç›®å½•
        mkdir -p build
        
        # å¤åˆ¶æ’ä»¶æ–‡ä»¶åˆ°ä¸´æ—¶ç›®å½•
        cp -r queqiao_mcdr build/
        cp mcdreforged.plugin.json build/
        cp requirements.txt build/
        cp README.md build/
        
        # å¦‚æœå­˜åœ¨ LICENSE æ–‡ä»¶ï¼Œä¹Ÿå¤åˆ¶è¿›å»
        if [ -f LICENSE ]; then
          cp LICENSE build/
        fi
        
        # åˆ›å»º zip æ–‡ä»¶
        cd build
        zip -r ../queqiao_mcdr-${{ steps.get_version.outputs.version }}.zip .
        cd ..
        
        # é‡å‘½åä¸º .mcdr æ–‡ä»¶
        mv queqiao_mcdr-${{ steps.get_version.outputs.version }}.zip queqiao_mcdr-${{ steps.get_version.outputs.version }}.mcdr
        
    - name: Generate release notes
      id: release_notes
      run: |
        cat > release_notes.md << 'EOF'
        ## QueQiao MCDR v${{ steps.get_version.outputs.version }}
        
        ### åŠŸèƒ½ç‰¹æ€§
        - ğŸŒ è·¨æœåŠ¡å™¨é€šä¿¡æ”¯æŒ
        - ğŸ“¡ WebSocket API æ¥å£
        - ğŸ’¬ å®æ—¶æ¶ˆæ¯å¹¿æ’­
        - ğŸ‘¥ ç©å®¶ç®¡ç†åŠŸèƒ½
        - ğŸ¨ å¯Œæ–‡æœ¬æ ¼å¼æ”¯æŒ
        - ğŸ” åŸºäºä»¤ç‰Œçš„èº«ä»½éªŒè¯
        
        ### å®‰è£…æ–¹æ³•
        1. ä¸‹è½½ `queqiao_mcdr-${{ steps.get_version.outputs.version }}.mcdr` æ–‡ä»¶
        2. å°†æ–‡ä»¶æ”¾å…¥ MCDReforged çš„ `plugins/` ç›®å½•
        3. é‡å¯æˆ–é‡è½½ MCDReforged
        4. ä½¿ç”¨ `!!queqiao help` æŸ¥çœ‹å¸®åŠ©ä¿¡æ¯
        
        ### ä¾èµ–è¦æ±‚
        - MCDReforged >= 2.0.0
        - minecraft_data_api >= 1.0.0
        - Python >= 3.8
        
        ### æ›´å¤šä¿¡æ¯
        è¯·æŸ¥çœ‹ [README.md](https://github.com/kterna/QueQiao_MCDR/blob/main/README.md) è·å–è¯¦ç»†çš„é…ç½®å’Œä½¿ç”¨è¯´æ˜ã€‚
        EOF
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        name: QueQiao MCDR v${{ steps.get_version.outputs.version }}
        body_path: release_notes.md
        files: |
          queqiao_mcdr-${{ steps.get_version.outputs.version }}.mcdr
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: queqiao_mcdr-${{ steps.get_version.outputs.version }}
        path: queqiao_mcdr-${{ steps.get_version.outputs.version }}.mcdr